const FIGURES = [
  "636c6173736963616c20706c696e746873000000000000000000000000000000",
  "726564206c616d626f726768696e690000000000000000000000000000000000",
  "70616c6d20747265650000000000000000000000000000000000000000000000",
  "636c6173736963616c2062757374000000000000000000000000000000000000",
  "646f6c7068696e206a756d70696e670000000000000000000000000000000000",
  "646f6c7068696e7320646976696e670000000000000000000000000000000000",
  "666c616d696e676f000000000000000000000000000000000000000000000000",
  "79656c6c6f77206c616d626f726768696e690000000000000000000000000000",
  "646f6c7068696e73207377696d6d696e67000000000000000000000000000000",
  "646f6c7068696e20646976696e67000000000000000000000000000000000000",
  "70616c6d20747265657300000000000000000000000000000000000000000000",
  "646f6c7068696e73206a756d70696e6700000000000000000000000000000000",
  "646f6c7068696e207377696d6d696e6700000000000000000000000000000000",
  "666c616d696e676f730000000000000000000000000000000000000000000000",
  "636c6173736963616c20627573742077656172696e6720736861646573000000",
  "636c6173736963616c20706c696e746800000000000000000000000000000000"
]

const BASES = [
  "6e656f6e20626c75652067726964000000000000000000000000000000000000",
  "636f6e736f6c6520677265656e20677269640000000000000000000000000000",
  "6e656f6e206c696d6520677265656e2067726964000000000000000000000000",
  "7468696e206e656f6e2070696e6b20747269616e676c65000000000000000000",
  "6e656f6e2070696e6b2062616e647320696e2070657273706563746976650000",
  "6e656f6e20677265656e20677269640000000000000000000000000000000000",
  "636f6e736f6c65206f72616e67652067726964206c616e647363617065000000",
  "636f6e736f6c65206f72616e6765206772696400000000000000000000000000",
  "726f61642073747265746368696e672061776179000000000000000000000000",
  "7468696e20636f6e736f6c6520677265656e20747269616e676c650000000000",
  "6e656f6e20677265656e2067726964206c616e64736361706500000000000000",
  "6e656f6e20626c75652067726964206c616e6473636170650000000000000000",
  "646961676f6e616c20636865737320626f617264000000000000000000000000",
  "636f6e736f6c6520677265656e2067726964206c616e64736361706500000000",
  "6e656f6e206c696d6520677265656e2067726964206c616e6473636170650000",
  "636865737320626f617264000000000000000000000000000000000000000000"
]

const BACKDROPS = [
  "707572706c652f70696e6b2073756e206469736b000000000000000000000000",
  "73756e206469736b207468726f7567682070696e6b2068617a65000000000000",
  "766964656f20696e746572666572656e63650000000000000000000000000000",
  "7265666c656374656420726970706c6573000000000000000000000000000000",
  "64697374616e74206369747973636170652073696c686f756574746564000000",
  "73706172736520636c6f75647300000000000000000000000000000000000000",
  "666c6174206f72616e67652073756e206469736b000000000000000000000000",
  "7265666c656374696f6e7320726970706c65206f6e2074686520666c6f6f7200",
  "79656c6c6f772f6f72616e6765206772616469656e742073756e206469736b00",
  "746967687420736861646f7773206f6e2074686520666c6f6f72000000000000",
  "73616e642064756e65732073747265746368696e672061776179000000000000",
  "73616e642064756e6573206174206e6967687400000000000000000000000000",
  "6c6f6e6720736861646f7773206f6e2074686520666c6f6f7200000000000000",
  "64697374616e74206d6f756e7461696e732073696c686f756574746564000000",
  "7265666c656374696f6e73206f6e2074686520666c6f6f720000000000000000",
  "7265642f70696e6b2073756e206469736b000000000000000000000000000000"
]

const GROUNDS = [
  "6379616e2f70696e6b206772616469656e740000000000000000000000000000",
  "676c69746368656420626c61636b000000000000000000000000000000000000",
  "636c6f7564730000000000000000000000000000000000000000000000000000",
  "6d6163682d62616e64656420737461726669656c640000000000000000000000",
  "707572706c652f6d6167656e7461206772616469656e74000000000000000000",
  "7374617273207365656e207468726f75676820636c6f75647300000000000000",
  "70696e6b2f7768697465206772616469656e7400000000000000000000000000",
  "73746174696320626c61636b0000000000000000000000000000000000000000",
  "737461726669656c640000000000000000000000000000000000000000000000",
  "676c69746368656420737461726669656c640000000000000000000000000000",
  "6f72616e67652f70696e6b2f707572706c65206772616469656e740000000000",
  "6f72616e67652f626c61636b206772616469656e740000000000000000000000",
  "6379616e20676175737369616e206e6f69736500000000000000000000000000",
  "70696e6b2f626c7565206772616469656e740000000000000000000000000000",
  "666c6174207761726d20626c75652d626c61636b000000000000000000000000",
  "6379616e2f6e61767920626c7565206772616469656e74000000000000000000"
]

const ELEMENTS = [FIGURES, BASES, BACKDROPS, GROUNDS]

// MOCK
const tokenOwnedIDs = tokenID => ELEMENTS.map(x => x[tokenID])

const hexToString = hex => {
  let str = ''
  for (let i = 0; i < hex.length; i += 2) {
	str += String.fromCharCode(parseInt(hex.substr(i, 2), 16))
  }
  return str
}

const hexToColour = async hex => {
  const digest = await window.crypto.subtle.digest('SHA-256',
                                                   new TextEncoder()
                                                   .encode(hex))
  const hash = Array.prototype.map.call(new Uint8Array(digest),
                                         x=>(('00'+x.toString(16))
                                             .slice(-2))).join('')
  return `#${hash.substr(0,6)}`
}

const idsToStrings = (hexIDs) => hexIDs.map(hexToString)

const idsToColours = (hexIDs) => hexIDs.map(hexToColour)

const currentTokenID = () =>
      parseInt(localStorage.getItem('currentTokenID')) - 1

const updateSelect = (parentTokenID) => {
  $('option').attr('selected', null)
  $(`option[value=${parentTokenID + 1}]`).attr('selected', true)
}

const updateStrings = async (parentTokenID) => {
  const ids = tokenOwnedIDs(parentTokenID)
  const strings = idsToStrings(ids)
  const colours = await Promise.all(idsToColours(ids))
  $('.text').remove()
  for(let i = 0; i < ids.length; i++) {
    $('#texts').append(`<div class="text" style="color: ${colours[i]};">${strings[i]}</div>`)
  }
}

$(document).ready(() => {

  const parentTokenID = currentTokenID()

  updateStrings(parentTokenID)
  updateSelect(parentTokenID)

  $('#help').fadeOut(8000)

  $('#content').click(() => $('#ui').fadeIn())

  $('#token-id-cancel').click(event => {
    event.stopPropagation()
    $('#ui').fadeOut()
  })

  $('#token-id-ok').click(event => {
    event.stopPropagation()
    localStorage.setItem('currentTokenID', $('#token-id-select').val())
    updateStrings(currentTokenID())
    $('#ui').fadeOut()
  })
  
})
